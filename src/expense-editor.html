<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="vaadin-date-picker-theme.html">

<dom-module id="expense-editor">
  <template>
    <style>
      #dialog {
        display: block;
        padding: 0 8px;
        border-top: 3px solid var(--accent-color);
        margin: 0;
        background: var(--primary-background-color);
        max-height: 100vh;
        /* Keep overflow visible so vaadin-date-picker dropdown won't clip */
        overflow: visible;
      }

      .main-layout {
        display: flex;
        flex-direction: row;
      }

      .flex {
        flex: 1;
      }

      .form {
        flex: 2;
      }

      #form > * {
        margin-bottom: 8px;
      }

      .buttons-layout {
        display: flex;
        flex-direction: row;
        margin-top: 16px;
      }

      .buttons-layout paper-button {
        width: 150px;
      }

      .save-button {
        background: var(--primary-color);
        color: var(--text-primary-color);
      }

      .main-layout h2 {
        font-size: 24px !important;
        font-weight: 300 !important;
      }

      paper-button[hidden] {
        display: none;
      }

      #error {
        color: red;
      }

      :host > .wrapper {
        height: 100%;
        width: 100%;
        padding: 0;
      }

      .close-button {
        color: var(--dark-primary-color);
      }

      .delete-button {
        margin-left: auto;
        color: var(--text-primary-color);
        background: var(--accent-color);
      }

      form::content label {
        font-weight: bold !important;
        color: #999 !important;
      }

      .wrapper {
        display: flex;
      }

      #toast[error] {
        --paper-toast-background-color: red;
      }

      #toast[success] {
        --paper-toast-background-color: green;
      }
    </style>


    <paper-dialog id="dialog" modal no-cancel-on-esc-key="false">
      <div class="main-layout">
        <h2>{{caption}}</h2>
        <span class="flex"></span>
        <paper-icon-button icon="close" on-tap="close" class="close-button self-start"></paper-icon-button>
      </div>

      <div class="wrapper">
        <div class="form">
          <iron-form id="form">
            <form>
              <iron-a11y-keys keys="enter" on-keys-pressed="_save"></iron-a11y-keys>
              <paper-input name="total" id="total" value="{{expense.amount}}" type="number" max="10000" label="Total"
                           required step="0.01" always-float-label>
                <div slot="suffix">&euro;</div>
              </paper-input>

              <vaadin-date-picker label="Date" placeholder="DD/MM/YYYY" value="{{expense.date}}" id="date" name="date"
                                  auto-validate required></vaadin-date-picker>
              <vaadin-combo-box id="category" name="category" label="Category" filtered-items="[[categories]]"
                                item-label-path="category" item-value-path="id" required></vaadin-combo-box>
              <paper-textarea id="comment" name="comment" label="Comment" value="{{expense.comment}}"
                              always-float-label></paper-textarea>
            </form>
          </iron-form>
        </div>
      </div>
      <div class="buttons-layout">
        <paper-button raised on-tap="_save" class="save-button">Save</paper-button>
        <paper-button on-tap="_delete" id="delete" class="delete-button">Delete</paper-button>
      </div>
      <span id="error"></span>
    </paper-dialog>

    <iron-ajax id="ajax" handle-as="json" method="POST" content-type="application/json;charset=UTF-8"
               on-response="_handleBackendResponse"
               on-error="_handleBackendError"></iron-ajax>

    <iron-ajax url="php/get_categories.php" handle-as="json" last-response="{{categories}}" debounce-duration="500"
               auto>
    </iron-ajax>

    <paper-toast id="toast"></paper-toast>
  </template>

  <script>
      class ExpenseEditor extends Polymer.Element {

          static get is() {
              return 'expense-editor';
          }

          static get properties() {
              return {
                  expense: {
                      type: Object,
                      notify: true,
                  },
                  caption: {
                      type: String,
                      computed: '_getCaption(expense)',
                  },
                  categories: {
                      type: Array,
                      notify: true,
                  },
              };
          }

          constructor() {
              super();
          }

          ready() {
              super.ready();
              this.$.date.i18n.formatDate = function(date) {
                  return fecha.format(date, 'DD/MM/YYYY');
              };
              this.$.date.i18n.parseDate = function(dateString) {
                  return fecha.parse(dateString, 'YYYY-MM-DD');
              };
          }

          _getCaption(expense) {
              if (expense.id) {
                  return 'Edit Expense';
              } else {
                  return 'Add Expense';
              }
          }

          _save() {
              this.$.error.innerText = '';
              if (this._validate(this.$.form)) {
                  this.expense.date = fecha.format(
                      fecha.parse(this.$.date._inputValue, 'DD/MM/YYYY'),
                      'YYYY-MM-DD');
                  if (!this.expense.hasOwnProperty('comment')) {
                      this.expense.comment = '';
                  }
                  this.expense.amount = Number(this.expense.amount);
                  this.$.ajax.url = 'php/save_expense.php';
                  this.$.ajax.body = JSON.stringify(this.expense);
                  this.$.ajax.generateRequest();
              } else {
                  this.$.dialog.scrollTop = 0;
                  this.$.error.innerText = 'Please fill all required fields';
              }
          }

          open(expense) {
              this.expense = expense;
              this.$.delete.hidden = !this.expense.id;
              this.$.dialog.open();
          }

          close() {
              this.expense = {};
              this._clear(this.$.form);
              this.$.dialog.close();
          }

          _delete() {
              this.$.ajax.url = 'php/delete_expense.php';
              this.$.ajax.body = JSON.stringify(this.expense);
              this.$.ajax.generateRequest();

              // Notify expense-page.html to update the expense table
              const event = new CustomEvent('expense-deleted',
                  {
                      detail: this.expense,
                      bubbles: true,
                      composed: true,
                  });
              this.dispatchEvent(event);

              this.close();
          }

          _validate(form) {
              const dates = form.getElementsByTagName('vaadin-date-picker');
              // TODO: check why iron-form validate is not correct
              let result = form.validate();

              // Validate vaadin-date-picker
              for (let i = 0, len = dates.length; i < len; i++) {
                  const input = dates[i].shadowRoot
                      .querySelector('vaadin-text-field');
                  const label = input.shadowRoot.querySelector('label');
                  const div = input.shadowRoot
                      .querySelector('div[part~="input-field"]');
                  if (!dates[i].checkValidity()) {
                      div.setAttribute('invalid', '');
                      label.setAttribute('invalid', '');
                      result = false;
                  } else {
                      div.removeAttribute('invalid');
                      label.removeAttribute('invalid');
                  }
              }
              return result;
          }

          _clear(form) {
              this.$.error.innerText = '';
              this.$.date._inputValue = '';

              const inputs = form.getElementsByTagName('paper-input');
              const dates = form.getElementsByTagName('vaadin-date-picker');
              const invalid = form.querySelectorAll('[invalid]');

              for (let i = 0, len = inputs.length; i < len; i++) {
                  let inv = inputs[i].shadowRoot.querySelector('[invalid]');
                  inv && inv.removeAttribute('invalid');
              }

              for (let i = 0, len = dates.length; i < len; i++) {
                  const input = dates[i].shadowRoot
                      .querySelector('vaadin-text-field');
                  const label = input.shadowRoot.querySelector('label');
                  const div = input.shadowRoot
                      .querySelector('div[part~="input-field"]');

                  div.removeAttribute('invalid');
                  label.removeAttribute('invalid');
              }

              for (let i = 0, len = invalid.length; i < len; i++) {
                  invalid[i].removeAttribute('invalid');
              }
          }

          _handleBackendResponse(evt) {
              const rsp = evt.detail.response;
              if (rsp && rsp.status) {
                  if (rsp.status === 'error') {
                      this.$.toast.removeAttribute('success');
                      this.$.toast.setAttribute('error', '');
                  } else {
                      this.$.toast.removeAttribute('error');
                      this.$.toast.setAttribute('success', '');

                      // Notify expense-page.html to update the expense table
                      if (this.expense.id) {
                          const event = new CustomEvent('expense-saved',
                              {
                                  detail: this.expense,
                                  bubbles: true,
                                  composed: true,
                              });
                          this.dispatchEvent(event);
                      } else {
                          this.expense.id = rsp.id;
                          const event = new CustomEvent('expense-added',
                              {
                                  detail: this.expense,
                                  bubbles: true,
                                  composed: true,
                              });
                          this.dispatchEvent(event);
                      }

                      this.close();
                  }
                  this.$.toast.show(rsp.message);
              } else {
                  this.$.toast.removeAttribute('success');
                  this.$.toast.setAttribute('error', '');
                  this.$.toast.show('No response');
              }
          }

          _handleBackendError() {
              this.$.toast.show('Error Contacting Server');
          }
      }

      window.customElements.define(ExpenseEditor.is, ExpenseEditor);
  </script>
</dom-module>
